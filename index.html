<script>
        // ==========================================
        // 1. PASTIKAN URL INI ADALAH URL DARI APPS SCRIPT ANDA
        // ==========================================
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzkKFRpVW0lVab9TGj9Z3xcUBsdk68o32BQ13Z_QR_lc-q-F7YpPxHC29J2XPtc0lAK/exec"; 

        // Fungsi Buka/Tutup Modal
        function bukaModal() { document.getElementById('uploadModal').style.display = 'flex'; }
        function tutupModal() { document.getElementById('uploadModal').style.display = 'none'; }

        // Fungsi Simpan Data
        function hantarData() {
            const topik = document.getElementById('topik').value;
            const link = document.getElementById('videoLink').value;
            const catatan = document.getElementById('catatan').value;
            const loader = document.getElementById('loader');

            if(!topik || !link) { alert("Sila pilih Topik dan masukkan Link Video."); return; }
            
            loader.style.display = 'block';

            fetch(WEB_APP_URL, {
                method: "POST",
                body: new URLSearchParams({ "action": "insert", "topik": topik, "link": link, "catatan": catatan })
            })
            .then(res => res.json())
            .then(data => {
                loader.style.display = 'none';
                if(data.result === 'success') {
                    alert("Berjaya disimpan!");
                    tutupModal();
                    document.getElementById('videoLink').value = "";
                    document.getElementById('catatan').value = "";
                    muatTurunData(); 
                } else {
                    alert("Ralat Script: " + data.error);
                }
            })
            .catch(err => {
                loader.style.display = 'none';
                alert("Gagal menyambung. Pastikan URL Apps Script betul.");
            });
        }

        // Fungsi Tumbnail (Kini dengan Safety Check)
        function getThumbnail(url) {
            if (!url) return '<div style="background:#444; height:100%; display:flex; align-items:center; justify-content:center; color:white;">Tiada Link</div>';
            
            // Cuba cari ID YouTube
            try {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);

                if (match && match[2].length === 11) {
                    return `<img src="https://img.youtube.com/vi/${match[2]}/mqdefault.jpg" alt="Video Thumb" onerror="this.src='https://via.placeholder.com/300x160?text=Video'"> <i class="fas fa-play-circle play-icon"></i>`;
                }
            } catch (e) {
                console.log("Link bukan YouTube atau link rosak");
            }

            // Jika bukan YouTube
            return `<div style="background:#2c3e50; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                        <i class="fas fa-video play-icon"></i>
                    </div>`;
        }

        // Fungsi Tarik Data
        function muatTurunData() {
            const gallery = document.getElementById('gallery');
            
            // Cek jika URL lupa diletak
            if (!WEB_APP_URL || WEB_APP_URL.includes("TEPEK_URL")) {
                gallery.innerHTML = '<p style="text-align:center; color:white; background:red; padding:10px;">RALAT: Sila masukkan URL Apps Script dalam kod HTML anda (Line 150+).</p>';
                return;
            }

            fetch(WEB_APP_URL)
            .then(res => res.json())
            .then(response => {
                gallery.innerHTML = ""; 
                const data = response.data;

                if (!data || data.length === 0) {
                    gallery.innerHTML = '<p style="text-align:center; color:white; grid-column: 1/-1;">Tiada video dijumpai. Sila muat naik video pertama.</p>';
                    return;
                }

                data.reverse().forEach(item => {
                    // Safety check jika link kosong dalam database
                    if(!item.link) return; 

                    const thumbHTML = getThumbnail(item.link);
                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.innerHTML = `
                        <div class="thumbnail-box">
                            ${thumbHTML}
                        </div>
                        <div class="card-info">
                            <div class="card-tag">${item.topik || "Umum"}</div>
                            <h3 class="card-title">${item.catatan || "Tiada Tajuk"}</h3> 
                            <div class="card-note"></div>
                            <a href="${item.link}" target="_blank" class="btn-watch">Tonton Video</a>
                        </div>
                    `;
                    gallery.appendChild(card);
                });
            })
            .catch(error => {
                console.error(error);
                // Paparkan error sebenar di skrin untuk memudahkan debug
                gallery.innerHTML = `<p style="text-align:center; color:white; background:rgba(255,0,0,0.5); padding:20px;">
                    <b>Gagal memuat turun data.</b><br>
                    Kemungkinan URL salah atau Internet perlahan.<br>
                    <small>${error.message}</small>
                </p>`;
            });
        }

        window.onload = muatTurunData;
        
        window.onclick = function(event) {
            const modal = document.getElementById('uploadModal');
            if (event.target == modal) tutupModal();
        }
    </script>
